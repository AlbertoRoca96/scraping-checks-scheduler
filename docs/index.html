<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scraping & Checks — Live Reports</title>
  <style>
    :root{
      --border:#e5e7eb; --bg:#f9fafb; --muted:#6b7280; --changed:#b45309; --ok:#047857; --err:#b91c1c;
      --card:#ffffff; --shadow:0 1px 2px rgba(0,0,0,.04), 0 6px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;padding:24px;font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#111827;background:#fff}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    h1{margin:0;font-size:1.6rem}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 12px;font:inherit;cursor:pointer}
    .btn:hover{background:#fafafa}

    /* Cards grid */
    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(520px,1fr))}
    @media (max-width:600px){ .grid{grid-template-columns:1fr} }

    section{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--card);box-shadow:var(--shadow)}
    h2{margin:.25rem 0 .5rem 0;font-size:1rem;display:flex;align-items:center;gap:8px}
    h2 a{font-weight:normal;font-size:.9rem}

    /* Table */
    table{width:100%;border-collapse:collapse; table-layout:auto}
    th,td{border-top:1px solid var(--border);padding:7px 8px;font-size:.95rem;vertical-align:top}
    th{background:var(--bg);text-align:left}

    td.check code{background:#f3f4f6;padding:2px 6px;border-radius:6px;display:inline-block}
    td.changed{white-space:nowrap}
    td.json, td.price, td.avail, td.pop{white-space:nowrap}

    /* Prevent the “one letter per line” look */
    td.keys, td.errcol{
      overflow-wrap:anywhere;
      word-break:normal;
      min-width:160px;
    }

    /* Desktop sizing hints */
    @media (min-width:900px){
      th.check, td.check{width:40%}
      th.changed, td.changed{width:96px}
      th.json, td.json{width:84px}
      th.price, td.price{width:200px}
      th.avail, td.avail{width:120px}
      th.pop, td.pop{width:140px}
    }

    /* Hide verbose columns on small screens */
    @media (max-width:820px){
      th.keys, td.keys, th.errcol, td.errcol{display:none}
    }
    @media (max-width:560px){
      th.json, td.json{display:none}
    }

    .changed-badge{color:var(--changed);font-weight:600}
    .dash{color:var(--muted)}
    .err{color:var(--err)}
    .empty{color:var(--muted);padding:6px 0}
    .pos{color:var(--ok)} .neg{color:var(--err)}
    .pill{padding:2px 9px;border-radius:999px;border:1px solid var(--border);font-size:.85rem}
    .pill.ok{color:#065f46;background:#ecfdf5;border-color:#a7f3d0}
    .pill.no{color:#7c2d12;background:#fef3c7;border-color:#fcd34d}
    .spark{display:block;width:140px;height:32px}
    .pricebox{display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Scraping & Checks — Live Reports</h1>
      <div class="toolbar">
        <button class="btn" id="refresh">Refresh</button>
        <span class="muted" id="stamp"></span>
      </div>
    </header>

    <div class="grid" id="grid"></div>
  </div>

  <script>
    const groups = ["default","seo","price","compliance"];
    const grid   = document.getElementById('grid');
    const stamp  = document.getElementById('stamp');
    document.getElementById('refresh').onclick = () => location.reload();

    // --- data helpers ---
    const bust = () => `?ts=${Date.now()}`;
    async function loadJSON(path){
      const res = await fetch(`${path}${bust()}`, { cache: "no-store" });
      if(!res.ok) throw new Error(path+" -> "+res.status);
      return res.json();
    }
    async function tryText(path){
      try{ const r = await fetch(`${path}${bust()}`); if(!r.ok) return null; return await r.text(); }
      catch{ return null; }
    }
    async function loadSeries(name){
      const txt = await tryText(`data/timeseries/${name}/series.jsonl`);
      if(!txt) return [];
      return txt.trim().split("\n").filter(Boolean).map(JSON.parse);
    }
    async function loadLatest(name){
      try{ return await loadJSON(`data/latest/${name}.json`); } catch{ return null; }
    }

    // --- tiny viz ---
    function sparkline(values){
      if(values.length < 2) return "";
      const w=140,h=32,n=values.length;
      const min=Math.min(...values), max=Math.max(...values), rng=(max-min)||1;
      const pts=values.map((v,i)=>`${(i/(n-1))*(w-2)+1},${h-((v-min)/rng)*(h-2)-1}`);
      return `<svg class="spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
        <path d="M${pts[0]} L ${pts.slice(1).join(" L ")}" fill="none" stroke="currentColor" stroke-width="2"/>
      </svg>`;
    }

    // --- table render ---
    function sectionHTML(group, summary){
      if(!summary?.length){
        return `<section><h2>Group: ${group}</h2><div class="empty">No checks found for this run.</div></section>`;
      }
      const rows = [...summary]
        .sort((a,b)=>Number(b.changed)-Number(a.changed) || a.name.localeCompare(b.name))
        .map(s=>`
          <tr data-check="${s.name}" data-type="${s.type}">
            <td class="check"><code>${s.name}</code></td>
            <td class="changed">${s.changed ? '<span class="changed-badge">changed</span>' : '<span class="dash">—</span>'}</td>
            <td class="keys">${(s.changedKeys||[]).join(", ")}</td>
            <td class="errcol">${s.error ? `<span class="err">${s.error}</span>` : ""}</td>
            <td class="json"><a href="data/latest/${s.name}.json">latest</a></td>
            <td class="price">${(s.type==='price'||s.type==='psa_price_row') ? '<span class="muted">loading…</span>' : ''}</td>
            <td class="avail">${s.type==='availability' ? '<span class="muted">loading…</span>' : ''}</td>
            <td class="pop">${s.type==='psa_pop_row' ? '<span class="muted">loading…</span>' : ''}</td>
          </tr>`).join("");

      const reportHref = `data/reports/report-${group}.html`;
      return `
        <section>
          <h2>Group: ${group} <a class="muted" href="${reportHref}">(view group report)</a></h2>
          <table>
            <thead>
              <tr>
                <th class="check">Check</th>
                <th class="changed">Changed</th>
                <th class="keys">Keys</th>
                <th class="errcol">Error</th>
                <th class="json">JSON</th>
                <th class="price">Price</th>
                <th class="avail">Avail.</th>
                <th class="pop">Pop.</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </section>`;
    }

    async function hydratePrices(){
      for(const tr of document.querySelectorAll('tr[data-type="price"], tr[data-type="psa_price_row"]')){
        const name = tr.getAttribute('data-check');
        const cell = tr.querySelector('.price');
        try{
          const series = await loadSeries(name);
          let last=null, prev=null;
          if(series.length){ last = series.at(-1)?.v; prev = series.at(-2)?.v ?? last; }
          else{ const rec = await loadLatest(name); last = rec?.data?.price ?? null; prev = last; }
          if(typeof last === "number"){
            const delta = (typeof prev==="number") ? (last - prev) : 0;
            const cls = delta >= 0 ? "pos" : "neg";
            const spark = series.length ? sparkline(series.map(p=>p.v)) : "";
            cell.innerHTML = `<div class="pricebox"><div>${last.toFixed(2)} <small class="${cls}">${delta>=0?'+':''}${delta.toFixed(2)}</small></div>${spark}</div>`;
          }else{ cell.innerHTML = ""; }
        }catch{ cell.innerHTML = ""; }
      }
    }

    async function hydrateAvailability(){
      for(const tr of document.querySelectorAll('tr[data-type="availability"]')){
        const name = tr.getAttribute('data-check');
        const cell = tr.querySelector('.avail');
        try{
          const series = await loadSeries(name);
          let val = series.length ? series.at(-1)?.v : null;
          if(val==null){ const rec = await loadLatest(name); val = typeof rec?.data?.available==="boolean" ? (rec.data.available?1:0) : null; }
          if(val===0 || val===1){
            const pill = `<span class="pill ${val ? 'ok':'no'}">${val ? 'Yes':'No'}</span>`;
            const spark = series.length ? sparkline(series.map(p=>p.v)) : "";
            cell.innerHTML = `<div class="pricebox">${pill}${spark}</div>`;
          } else { cell.innerHTML = ""; }
        }catch{ cell.innerHTML = ""; }
      }
    }

    async function hydratePopulation(){
      for(const tr of document.querySelectorAll('tr[data-type="psa_pop_row"]')){
        const name = tr.getAttribute('data-check');
        const cell = tr.querySelector('.pop');
        try{
          const series = await loadSeries(name);
          let last=null;
          if(series.length){ last = series.at(-1)?.v; }
          else{ const rec = await loadLatest(name); last = rec?.data?.population ?? null; }
          if(typeof last === "number"){
            const spark = series.length ? sparkline(series.map(p=>p.v)) : "";
            cell.innerHTML = `<div class="pricebox"><div>${last.toLocaleString()}</div>${spark}</div>`;
          }else{ cell.innerHTML = ""; }
        }catch{ cell.innerHTML = ""; }
      }
    }

    // --- boot ---
    (async () => {
      for(const g of groups){
        try{
          const r = await loadJSON(`data/report-${g}.json`);
          if(!stamp.textContent){
            stamp.textContent = "Generated at " + new Date(r.generatedAt).toLocaleString();
          }
          const div = document.createElement('div');
          div.innerHTML = sectionHTML(r.group || g, r.summary || []);
          grid.appendChild(div.firstElementChild);
        }catch{/* group not present */}
      }
      await hydratePrices();
      await hydrateAvailability();
      await hydratePopulation();
    })();
  </script>
</body>
</html>
