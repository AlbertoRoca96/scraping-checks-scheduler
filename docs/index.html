<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scraping & Checks — Live Reports</title>

  <!-- Chart.js (official CDN include) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --border:#e5e7eb; --bg:#f9fafb; --muted:#6b7280; --changed:#b45309; --ok:#047857; --err:#b91c1c;
      --card:#ffffff; --shadow:0 1px 2px rgba(0,0,0,.04), 0 6px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;padding:24px;font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#111827;background:#fff}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    h1{margin:0;font-size:1.6rem}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 12px;font:inherit;cursor:pointer}
    .btn:hover{background:#fafafa}

    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(520px,1fr))}
    @media (max-width:600px){ .grid{grid-template-columns:1fr} }

    section{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--card);box-shadow:var(--shadow)}
    h2{margin:.25rem 0 .5rem 0;font-size:1rem;display:flex;align-items:center;gap:8px}
    h2 a{font-weight:normal;font-size:.9rem}

    table{width:100%;border-collapse:collapse; table-layout:auto}
    th,td{border-top:1px solid var(--border);padding:7px 8px;font-size:.95rem;vertical-align:top}
    th{background:var(--bg);text-align:left}
    td.check code{background:#f3f4f6;padding:2px 6px;border-radius:6px;display:inline-block}
    td.changed{white-space:nowrap}
    td.json, td.price, td.avail, td.pop{white-space:nowrap}

    td.keys, td.errcol{overflow-wrap:anywhere;word-break:normal;min-width:160px;}
    @media (min-width:900px){
      th.check, td.check{width:40%}
      th.changed, td.changed{width:96px}
      th.json, td.json{width:84px}
      th.price, td.price{width:200px}
      th.avail, td.avail{width:120px}
      th.pop, td.pop{width:140px}
    }
    @media (max-width:820px){ th.keys, td.keys, th.errcol, td.errcol{display:none} }
    @media (max-width:560px){ th.json, td.json{display:none} }

    .changed-badge{color:var(--changed);font-weight:600}
    .dash{color:var(--muted)}
    .err{color:var(--err)}
    .empty{color:var(--muted);padding:6px 0}
    .pos{color:var(--ok)} .neg{color:var(--err)}
    .pill{padding:2px 9px;border-radius:999px;border:1px solid var(--border);font-size:.85rem}
    .pill.ok{color:#065f46;background:#ecfdf5;border-color:#a7f3d0}
    .pill.no{color:#7c2d12;background:#fef3c7;border-color:#fcd34d}
    .spark{display:block;width:140px;height:32px}
    .pricebox{display:flex;align-items:center;gap:10px}

    /* Stocks card */
    .stockgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:8px}
    .stock{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;box-shadow:var(--shadow)}
    .stock .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .stock .sym{font-weight:700}
    .stock .chg{font-size:.9rem}
    .stock .big{font-size:1.3rem;font-weight:700}
    .chartwrap{margin-top:8px}
    .chartwrap canvas{width:100%;height:140px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Scraping & Checks — Live Reports</h1>
      <div class="toolbar">
        <button class="btn" id="refresh">Refresh</button>
        <span class="muted" id="stamp"></span>
      </div>
    </header>

    <div class="grid" id="grid"></div>
  </div>

  <script>
    // We will always try 'all' first, but render any group that exists.
    const GROUPS_TO_TRY = ["all","stocks","default","seo","price","compliance"];

    const grid  = document.getElementById('grid');
    const stamp = document.getElementById('stamp');
    document.getElementById('refresh').onclick = () => location.reload();

    // --- data helpers ---
    const bust = () => `?ts=${Date.now()}`;

    async function loadJSON(path){
      const res = await fetch(`${path}${bust()}`, { cache: "no-store" });
      if(!res.ok) throw new Error(path+" -> "+res.status);
      return res.json();
    }
    async function tryText(path){
      try{
        const r = await fetch(`${path}${bust()}`, { cache: "no-store" });
        if(!r.ok) return null;
        return await r.text();
      }catch{ return null; }
    }
    async function loadSeries(name){
      const txt = await tryText(`data/timeseries/${name}/series.jsonl`);
      if(!txt) return [];
      return txt.trim().split("\n").filter(Boolean).map(JSON.parse);
    }
    async function loadLatest(name){
      try{ return await loadJSON(`data/latest/${name}.json`); } catch{ return null; }
    }

    // --- tiny viz ---
    function sparkline(values){
      if(values.length < 2) return "";
      const w=140,h=32,n=values.length;
      const min=Math.min(...values), max=Math.max(...values), rng=(max-min)||1;
      const pts=values.map((v,i)=>`${(i/(n-1))*(w-2)+1},${h-((v-min)/rng)*(h-2)-1}`);
      return `<svg class="spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
        <path d="M${pts[0]} L ${pts.slice(1).join(" L ")}" fill="none" stroke="currentColor" stroke-width="2"/>
      </svg>`;
    }

    // --- generic table section ---
    function sectionHTML(group, summary){
      if(group === "stocks") return stocksSectionHTML(summary);
      if(!summary?.length){
        return `<section><h2>Group: ${group}</h2><div class="empty">No checks found for this run.</div></section>`;
      }
      const rows = [...summary]
        .sort((a,b)=>Number(b.changed)-Number(a.changed) || a.name.localeCompare(b.name))
        .map(s=>`
          <tr data-check="${s.name}" data-type="${s.type}">
            <td class="check"><code>${s.name}</code></td>
            <td class="changed">${s.changed ? '<span class="changed-badge">changed</span>' : '<span class="dash">—</span>'}</td>
            <td class="keys">${(s.changedKeys||[]).join(", ")}</td>
            <td class="errcol">${s.error ? `<span class="err">${s.error}</span>` : ""}</td>
            <td class="json"><a href="data/latest/${s.name}.json">latest</a></td>
            <td class="price">${(s.type==='price'||s.type==='psa_price_row') ? '<span class="muted">loading…</span>' : ''}</td>
            <td class="avail">${s.type==='availability' ? '<span class="muted">loading…</span>' : ''}</td>
            <td class="pop">${s.type==='psa_pop_row' ? '<span class="muted">loading…</span>' : ''}</td>
          </tr>`).join("");

      const reportHref = `data/reports/report-${group}.html`;
      return `
        <section>
          <h2>Group: ${group} <a class="muted" href="${reportHref}">(view group report)</a></h2>
          <table>
            <thead>
              <tr>
                <th class="check">Check</th>
                <th class="changed">Changed</th>
                <th class="keys">Keys</th>
                <th class="errcol">Error</th>
                <th class="json">JSON</th>
                <th class="price">Price</th>
                <th class="avail">Avail.</th>
                <th class="pop">Pop.</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </section>`;
    }

    // --- Stocks card with live chart ---
    function stocksSectionHTML(summary){
      const items = summary
        .filter(s => s.type === "stock_quote")
        .map(s => `
          <div class="stock" data-check="${s.name}">
            <div class="head">
              <div class="sym">${s.name.replace(/^stock_([^_]+).*$/,'$1').toUpperCase()}</div>
              <a class="muted" href="data/latest/${s.name}.json">json</a>
            </div>
            <div class="big" data-role="price">loading…</div>
            <div class="chg muted" data-role="chg"></div>
            <div class="chartwrap"><canvas data-role="chart"></canvas></div>
          </div>
        `).join("");
      return `
        <section>
          <h2>Stocks</h2>
          ${items ? `<div class="stockgrid">${items}</div>` : `<div class="empty">No stocks configured.</div>`}
        </section>
      `;
    }

    async function hydratePrices(){
      for(const tr of document.querySelectorAll('tr[data-type="price"], tr[data-type="psa_price_row"]')){
        const name = tr.getAttribute('data-check');
        const cell = tr.querySelector('.price');
        try{
          const series = await loadSeries(name);
          let last=null, prev=null;
          if(series.length){ last = series.at(-1)?.v; prev = series.at(-2)?.v ?? last; }
          else{ const rec = await loadLatest(name); last = rec?.data?.price ?? null; prev = last; }
          if(typeof last === "number"){
            const delta = (typeof prev==="number") ? (last - prev) : 0;
            const cls = delta >= 0 ? "pos" : "neg";
            const spark = series.length ? sparkline(series.map(p=>p.v)) : "";
            cell.innerHTML = `<div class="pricebox"><div>${last.toFixed(2)} <small class="${cls}">${delta>=0?'+':''}${delta.toFixed(2)}</small></div>${spark}</div>`;
          }else{ cell.innerHTML = ""; }
        }catch{ cell.innerHTML = ""; }
      }
    }

    async function hydrateAvailability(){
      for(const tr of document.querySelectorAll('tr[data-type="availability"]')){
        const name = tr.getAttribute('data-check');
        const cell = tr.querySelector('.avail');
        try{
          const series = await loadSeries(name);
          let val = series.length ? series.at(-1)?.v : null;
          if(val==null){ const rec = await loadLatest(name); val = typeof rec?.data?.available==="boolean" ? (rec.data.available?1:0) : null; }
          if(val===0 || val===1){
            const pill = `<span class="pill ${val ? 'ok':'no'}">${val ? 'Yes':'No'}</span>`;
            const spark = series.length ? sparkline(series.map(p=>p.v)) : "";
            cell.innerHTML = `<div class="pricebox">${pill}${spark}</div>`;
          } else { cell.innerHTML = ""; }
        }catch{ cell.innerHTML = ""; }
      }
    }

    async function hydratePopulation(){
      for(const tr of document.querySelectorAll('tr[data-type="psa_pop_row"]')){
        const name = tr.getAttribute('data-check');
        const cell = tr.querySelector('.pop');
        try{
          const series = await loadSeries(name);
          let last=null;
          if(series.length){ last = series.at(-1)?.v; }
          else{ const rec = await loadLatest(name); last = rec?.data?.population ?? null; }
          if(typeof last === "number"){
            const spark = series.length ? sparkline(series.map(p=>p.v)) : "";
            cell.innerHTML = `<div class="pricebox"><div>${last.toLocaleString()}</div>${spark}</div>`;
          }else{ cell.innerHTML = ""; }
        }catch{ cell.innerHTML = ""; }
      }
    }

    // Stock charts (Chart.js)
    const stockCharts = new Map();
    function upsertLineChart(canvas, labels, values){
      const key = canvas;
      if(!stockCharts.has(key)){
        const ctx = canvas.getContext('2d');
        const chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Price', data: values, tension: 0.25 }] },
          options: {
            responsive: true,
            animation: false,
            scales: { x: { display: false }, y: { ticks: { callback: v => v } } },
            plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
          }
        });
        stockCharts.set(key, chart);
      } else {
        const ch = stockCharts.get(key);
        ch.data.labels = labels;
        ch.data.datasets[0].data = values;
        ch.update();
      }
    }

    async function hydrateStocks(){
      for(const el of document.querySelectorAll('.stock[data-check]')){
        const name = el.getAttribute('data-check');
        const priceEl = el.querySelector('[data-role="price"]');
        const chgEl   = el.querySelector('[data-role="chg"]');
        const canvas  = el.querySelector('[data-role="chart"]');
        try{
          const series = await loadSeries(name);
          const latest = await loadLatest(name);
          const last = series.length ? series.at(-1)?.v : latest?.data?.price ?? null;
          const prev = series.length > 1 ? series.at(-2)?.v : last;
          if(typeof last === "number"){
            const delta = (typeof prev === "number") ? (last - prev) : null;
            const cls = (delta ?? 0) >= 0 ? "pos" : "neg";
            const pct = latest?.data?.changePercent;
            priceEl.innerHTML = `${last.toFixed(2)}`;
            chgEl.innerHTML = (delta == null)
              ? ""
              : `<span class="${cls}">${delta>=0?'+':''}${delta.toFixed(2)}${typeof pct==='number' ? ` (${pct.toFixed(2)}%)` : ""}</span>`;

            const labels = series.map(p => new Date(p.t).toLocaleString());
            const values = series.map(p => p.v);
            if(labels.length > 1) upsertLineChart(canvas, labels, values);
          } else {
            priceEl.textContent = "";
            chgEl.textContent = "";
          }
        } catch {
          priceEl.textContent = "";
          chgEl.textContent = "";
        }
      }
    }

    // --- boot ---
    (async () => {
      const seenGroups = new Set();
      const allSummary = [];

      for(const g of GROUPS_TO_TRY){
        try{
          const r = await loadJSON(`data/report-${g}.json`);
          const groupName = r.group || g;
          if(!stamp.textContent) stamp.textContent = "Generated at " + new Date(r.generatedAt).toLocaleString();

          // avoid rendering the same logical group twice
          if(seenGroups.has(groupName)) continue;
          seenGroups.add(groupName);

          allSummary.push(...(r.summary || []));
          const div = document.createElement('div');
          div.innerHTML = sectionHTML(groupName, r.summary || []);
          grid.appendChild(div.firstElementChild);
        }catch{/* group may be absent */}
      }

      // If no dedicated stocks report exists, synthesize a Stocks section from whatever we loaded.
      if(!seenGroups.has("stocks")){
        const stockItems = allSummary.filter(s => s.type === "stock_quote");
        if(stockItems.length){
          const div = document.createElement('div');
          div.innerHTML = sectionHTML("stocks", stockItems);
          grid.prepend(div.firstElementChild); // put it first
        }
      }

      await hydratePrices();
      await hydrateAvailability();
      await hydratePopulation();
      await hydrateStocks();

      // Light auto-refresh of stock charts (every 60s)
      setInterval(hydrateStocks, 60000);
    })();
  </script>
</body>
</html>
